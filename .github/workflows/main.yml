name: Deploy React Frontend to GCP VM

# 1. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ ì •ì˜
on:
  push:
    branches:
      - main
      - proto
    paths:
      - '**'

  # ğŸ’¡ ìˆ˜ë™ ì‹¤í–‰(Manual Trigger) ì˜µì…˜ ì¶”ê°€ 
  workflow_dispatch: {}
      
# 2. ì‹¤í–‰ë  ì‘ì—…(Job) ì •ì˜
jobs:
  deploy:
    # ì´ ì‘ì—…ì´ ì‹¤í–‰ë  ê°€ìƒ í™˜ê²½ ì •ì˜ (GitHub Runner)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # 3. ì‘ì—…ì˜ ë‹¨ê³„(Steps) ì •ì˜
    steps:
      # Git ë ˆí¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ Runner í™˜ê²½ìœ¼ë¡œ ë³µì œí•©ë‹ˆë‹¤.
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # 1ë‹¨ê³„: SSH í‚¤ ì„¤ì •
      # GitHub Secretì— ì €ì¥ëœ ë¹„ê³µê°œ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ VM ì ‘ì† ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # SSH_PRIVATE_KEY Secret (ê°œì¸ í‚¤ íŒŒì¼ ë‚´ìš©) ì‚¬ìš©
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 2ë‹¨ê³„: SSHë¥¼ í†µí•´ VMìœ¼ë¡œ íŒŒì¼ ì „ì†¡ (rsync ì‚¬ìš©)
      - name: Transfer Files to VM
        run: |
          # SSH ì ‘ì† ì‹œ ë³´ì•ˆ ê²½ê³ ë¥¼ ë¬´ì‹œí•˜ë„ë¡ VM_HOST_IPë¥¼ known_hostsì— ë“±ë¡
          ssh-keyscan -H ${{ secrets.VM_HOST_IP }} >> ~/.ssh/known_hosts
          
          # rsync ëª…ë ¹ìœ¼ë¡œ Runnerì˜ ì½”ë“œë¥¼ VMì˜ ëª©í‘œ ë””ë ‰í† ë¦¬ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.
          rsync -avz --delete --exclude 'node_modules' --exclude 'dist' ./ ${{ secrets.VM_USER }}@${{ secrets.VM_HOST_IP }}:${{ secrets.VM_TARGET_DIR }}
        
      # 3ë‹¨ê³„: SSHë¥¼ í†µí•´ Docker Compose ëª…ë ¹ ì‹¤í–‰
      # appleboy/ssh-action ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì—¬ VMì—ì„œ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Deploy and Restart Frontend Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST_IP }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "--- Navigating to deployment directory ---"
            cd ${{ secrets.VM_TARGET_DIR }}
            cd ..
            echo "--- Starting Frontend Build and Deployment ---"
            
            # Docker Composeë¥¼ ì‚¬ìš©í•˜ì—¬ frontend-app ì„œë¹„ìŠ¤ë§Œ ì¬ë°°í¬í•©ë‹ˆë‹¤.
            # /usr/local/bin/docker-compose ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.
            # -d: ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
            # --no-deps: ì˜ì¡´ì„±(nestjs-app)ì„ ë‹¤ì‹œ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            # --build: Dockerfileì„ ì‚¬ìš©í•˜ì—¬ React ì•±ì„ ìƒˆë¡œ ë¹Œë“œí•¨
            
            # /usr/local/bin/docker-compose up -d --no-deps --build frontend-app
            # /usr/local/bin/docker-compose build --build-arg VITE_API_BASE_URL="${{ secrets.VITE_FRONTEND_API_BASE_URL }}" frontend-app
            # /usr/local/bin/docker-compose up -d --no-deps frontend-app
            # /usr/local/bin/docker-compose up -d --no-deps --build --no-cache --build-arg VITE_API_BASE_URL="${{ secrets.VITE_FRONTEND_API_BASE_URL }}" --force-recreate frontend-app

            echo "--- Building new image ---"
            /usr/local/bin/docker-compose build --no-cache \
              --build-arg VITE_API_BASE_URL="${{ secrets.VITE_FRONTEND_API_BASE_URL }}" frontend-app
            echo "--- Restarting container ---"
            /usr/local/bin/docker-compose up -d --no-deps --force-recreate frontend-app
            
            echo "--- React Frontend Deployment complete on ${{ secrets.VM_HOST_IP }} ---"