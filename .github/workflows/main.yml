name: Deploy GCP VM
run-name: "[${{ github.ref_name }}] [${{ github.event.head_commit.message }}] [${{ github.actor }}]"

on:
  push:
    branches:
      - main
      - proto

  pull_request:
    branches: [ "main", "proto" ]
    types: [labeled]
    

  # ğŸ’¡ ìˆ˜ë™ ì‹¤í–‰(Manual Trigger) ì˜µì…˜ ì¶”ê°€ 
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  # 1. pull_request ì´ë²¤íŠ¸ì—ì„œ ë ˆì´ë¸” ê²€ì‚¬ë§Œ í•˜ëŠ” Job
  check_pr_label:
    runs-on: ubuntu-latest
    
    # pull_request ì´ë²¤íŠ¸ì´ê³ , íŠ¹ì • ë ˆì´ë¸”ë§Œ ì‹¤í–‰
    # if: github.event_name == 'pull_request' 
    #    && (github.event.label.name == 'documentation' || github.event.label.name == 'dep')
    
    steps:
      - name: Label Check Passed
        run: echo "Label check passed for PR."

  deploy:
    # ì´ ì‘ì—…ì´ ì‹¤í–‰ë  ê°€ìƒ í™˜ê²½ ì •ì˜ (GitHub Runner)
    runs-on: ubuntu-latest

    # check_pr_label Jobì— ì˜ì¡´í•©ë‹ˆë‹¤.
    # check_pr_label Jobì´ ìŠ¤í‚µë˜ë©´ deploy Jobì€ ì‹¤í–‰ë©ë‹ˆë‹¤.
    # (ë‹¨, push ì´ë²¤íŠ¸ì¼ ë•Œë§Œ í•´ë‹¹ Jobì´ ìŠ¤í‚µë˜ë¯€ë¡œ ì˜ë„ëŒ€ë¡œ ì‘ë™í•©ë‹ˆë‹¤.)
    needs: [check_pr_label]

    # 1) ì´ë²¤íŠ¸ê°€ 'push' ì´ê±°ë‚˜ (push ì´ë²¤íŠ¸ëŠ” ë ˆì´ë¸”ê³¼ ë¬´ê´€í•˜ê²Œ ì‹¤í–‰)
    # 2) ì´ë²¤íŠ¸ê°€ 'pull_request'ì´ê³ , 'check_pr_label' Jobì´ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    # if: github.event_name == 'push' || (github.event_name == 'pull_request' && success())
    
    steps:
      # Git ë ˆí¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ Runner í™˜ê²½ìœ¼ë¡œ ë³µì œ
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 1. Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      # 2. Docker ë¹Œë“œ í™˜ê²½ ì„¤ì •
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
          
      # 3. í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (frontend-app)
      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./dockerfiles/frontend.Dockerfile 
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/siksa-frontend-app:latest
          build-args: VITE_API_BASE_URL=${{ secrets.VITE_FRONTEND_API_BASE_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 4. SSHë¥¼ í†µí•´ VM ì ‘ì† ë° ì´ë¯¸ì§€ pull/ì‹¤í–‰
      - name: Deploy Containers on VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST_IP }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "--- Navigating to deployment directory ---"
            cd ${{ secrets.VM_TARGET_DIR }}
            
            # 6. VMì—ì„œ Docker Hub ë¡œê·¸ì¸
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            
            # 7. ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (pull)
            echo "--- Pulling latest images from Docker Hub ---"
            /usr/local/bin/docker-compose pull
            # /usr/local/bin/docker-compose -f ../docker-compose.yml pull
            
            # 8. ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (--no-build ì˜µì…˜ìœ¼ë¡œ ë¹Œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤)
            echo "--- Starting containers with latest images ---"
            /usr/local/bin/docker-compose up -d --force-recreate --no-build
            # /usr/local/bin/docker-compose -f ../docker-compose.yml up -d --force-recreate --no-build

            echo "--- Deployment complete ---"