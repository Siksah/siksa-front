name: Deploy GCP VM

on:
  push:
    branches:
      - main
      - proto
    paths:
      - '**'
  # ğŸ’¡ ìˆ˜ë™ ì‹¤í–‰(Manual Trigger) ì˜µì…˜ ì¶”ê°€ 
  workflow_dispatch: {}
      
jobs:
  deploy:
    # ì´ ì‘ì—…ì´ ì‹¤í–‰ë  ê°€ìƒ í™˜ê²½ ì •ì˜ (GitHub Runner)
    runs-on: ubuntu-latest
    steps:
      # Git ë ˆí¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ Runner í™˜ê²½ìœ¼ë¡œ ë³µì œ
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 1. Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      # 2. Docker ë¹Œë“œ í™˜ê²½ ì„¤ì •
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
          
      # 3. í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (frontend-app)
      - name: Build and Push Frontend Image
        # siksa-front í´ë”ì— ë³€ê²½ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
        uses: docker/build-push-action@v5
        with:
          context: ./siksa-front
          file: ./siksa-front/dockerfiles/frontend.Dockerfile 
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/siksa-frontend-app:latest
          build-args: VITE_API_BASE_URL=${{ secrets.VITE_FRONTEND_API_BASE_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 4. SSHë¥¼ í†µí•´ VM ì ‘ì† ë° ì´ë¯¸ì§€ pull/ì‹¤í–‰
      - name: Deploy Containers on VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST_IP }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "--- Navigating to deployment directory ---"
            cd ${{ secrets.VM_TARGET_DIR }}
            
            # 6. VMì—ì„œ Docker Hub ë¡œê·¸ì¸
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            
            # 7. ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (pull)
            echo "--- Pulling latest images from Docker Hub ---"
            /usr/local/bin/docker-compose pull
            
            # 8. ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (--no-build ì˜µì…˜ìœ¼ë¡œ ë¹Œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤)
            echo "--- Starting containers with latest images ---"
            /usr/local/bin/docker-compose up -d --force-recreate --no-build
            
            echo "--- Deployment complete ---"