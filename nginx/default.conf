# =========================================================
# 1. HTTP (80 í¬íŠ¸) ë¸”ë¡: HTTPSë¡œ ê°•ì œ ë¦¬ë””ë ‰ì…˜
# =========================================================
server {
    # 80 í¬íŠ¸ë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  HTTP ìš”ì²­ì„ ìˆ˜ì‹ 
    listen 80;
    server_name nyamnyam.kr www.nyamnyam.kr;

    # 301 ì˜êµ¬ ì´ë™ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ìš”ì²­ì„ HTTPSë¡œ ë¦¬ë””ë ‰ì…˜
    return 301 https://$host$request_uri;
}

# =========================================================
# 2. HTTPS (443 í¬íŠ¸) ë¸”ë¡: ì‹¤ì œ ì„œë¹„ìŠ¤ ì œê³µ
# =========================================================
server {

    # 443 í¬íŠ¸ì—ì„œ HTTPS ìš”ì²­ì„ ìˆ˜ì‹  (SSL ë° HTTP/2 í”„ë¡œí† ì½œ í™œì„±í™”)
    listen 443 ssl http2;
    server_name nyamnyam.kr www.nyamnyam.kr;

    # ----------------------------------------------------
    # ğŸ‘‡ SSL/TLS ì¸ì¦ì„œ ì„¤ì •
    # Certbotìœ¼ë¡œ ë°œê¸‰ë°›ì€ ê²½ìš°ì˜ ì¼ë°˜ì ì¸ ê²½ë¡œì…ë‹ˆë‹¤.
    # ğŸš¨ğŸš¨ğŸš¨ ì´ ë‘ ê²½ë¡œë¥¼ ì‹¤ì œ ì¸ì¦ì„œ íŒŒì¼ ê²½ë¡œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤! ğŸš¨ğŸš¨ğŸš¨
    # ----------------------------------------------------
    ssl_certificate /etc/letsencrypt/live/nyamnyam.kr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/nyamnyam.kr/privkey.pem;

    # SSL ë³´ì•ˆ ê°•í™”ë¥¼ ìœ„í•œ ê¶Œì¥ ì˜µì…˜ (ì„ íƒ ì‚¬í•­)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    # ----------------------------------------------------

    # Nginxê°€ Reactì˜ ë¹Œë“œëœ ì •ì  íŒŒì¼(index.html, .js, .css ë“±)ì„ ì°¾ì„ ë£¨íŠ¸ ë””ë ‰í† ë¦¬
    # ê¸°ë³¸ index íŒŒì¼ ì„¤ì •: ìš”ì²­ì´ í´ë”ë¡œ ë“¤ì–´ì™”ì„ ë•Œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•  íŒŒì¼
    index index.html;
    # ì´ ê²½ë¡œëŠ” frontend.Dockerfileì—ì„œ íŒŒì¼ì„ ë³µì‚¬í•œ ìœ„ì¹˜
    root /usr/share/nginx/html;

    # ----------------------------------------------------
    # ğŸ‘‡ í”„ë¡ íŠ¸ì—”ë“œ (React SPA) ì„œë¹™
    # ----------------------------------------------------
    # ëª¨ë“  ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    location / {
        # try_files $uri $uri/ /index.html;
        # ì´ ì„¤ì •ì´ SPA(Single Page Application)ì—ì„œ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤.
        # Nginxê°€ ìš”ì²­ëœ URI($uri)ë¥¼ ì°¾ì§€ ëª»í•  ê²½ìš° (ì˜ˆ: /about ê²½ë¡œ), 
        # 404 ì˜¤ë¥˜ ëŒ€ì‹  React ì•±ì˜ ê¸°ë³¸ íŒŒì¼ì¸ /index.htmlì„ ë°˜í™˜í•˜ì—¬ 
        # React Routerê°€ ê²½ë¡œ ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•˜ê²Œ í•©ë‹ˆë‹¤.
        try_files $uri $uri/ /index.html; 
    }
    
    # ----------------------------------------------------
    # ğŸ‘‡ API ìš”ì²­ ë°±ì—”ë“œ (NestJS) í”„ë¡ì‹œ
    # ----------------------------------------------------
    # ë¸Œë¼ìš°ì €ì—ì„œ '/api/users'ì™€ ê°™ì€ ìš”ì²­ì´ ì˜¤ë©´,
    # Nginxê°€ ì´ ìš”ì²­ì„ Docker ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ì˜ NestJS ì»¨í…Œì´ë„ˆë¡œ ì „ë‹¬(API ìš”ì²­ì„ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆë¡œ í”„ë¡ì‹œ)
    location /api/ {
        # proxy_pass: Docker ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ì˜ NestJS ì»¨í…Œì´ë„ˆë¡œ ìš”ì²­ì„ ì „ë‹¬(ìš”ì²­ì„ ì „ë‹¬í•  ëª©ì ì§€)
        # http://nestjs-app:3001 ì—ì„œ 'nestjs-app'ì€ docker-compose.ymlì— ì •ì˜ëœ ì„œë¹„ìŠ¤ ì´ë¦„ì…ë‹ˆë‹¤.
        # backend-app: docker-compose.ymlì— ì •ì˜ëœ NestJS ì„œë¹„ìŠ¤ ì´ë¦„
        # 3001ì€ NestJS ì»¨í…Œì´ë„ˆì˜ ë‚´ë¶€ í¬íŠ¸ì…ë‹ˆë‹¤.
        proxy_pass http://backend-app:3001/;
        
        # ë°±ì—”ë“œ ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì˜ ì‹¤ì œ IPì™€ í˜¸ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ìˆë„ë¡ í—¤ë”ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # ğŸ’¡ ì¤‘ìš”: NestJSì— ìš”ì²­ì´ HTTPSë¡œ ë“¤ì–´ì™”ìŒì„ ì•Œë¦¼
        proxy_set_header X-Forwarded-Proto https;
    }
}